<?php
// =======================================================
// تفعيل عرض الأخطاء (لأغراض التطوير فقط)
// يساعد على اكتشاف الأخطاء أثناء البرمجة
// =======================================================

// عرض الأخطاء أثناء التنفيذ
ini_set('display_errors', 1);

// عرض أخطاء بدء التشغيل
ini_set('display_startup_errors', 1);

// إظهار جميع أنواع الأخطاء والتحذيرات
error_reporting(E_ALL);

// =======================================================
// بدء جلسة المستخدم
// الجلسة تُستخدم لتخزين:
// - بيانات المستخدم
// - العربة (cart)
// - الرسائل المؤقتة (flash)
// =======================================================
session_start();

// =======================================================
// تحميل ملفات النظام الأساسية
// =======================================================

// تحميل الإعدادات العامة (ثوابت المشروع)
require_once __DIR__ . '/../config.php';

// تحميل دوال الاتصال بقاعدة البيانات
require_once __DIR__ . '/../db.php';

// تحميل دوال التحقق من تسجيل الدخول
require_once __DIR__ . '/../auth.php';

// =======================================================
// التأكد أن المستخدم مسجل دخول
// إذا لم يكن مسجلًا، سيتم تحويله تلقائيًا
// =======================================================
require_login();

// =======================================================
// إنشاء اتصال بقاعدة البيانات
// =======================================================
$pdo = db();

// =======================================================
// قراءة محتويات العربة من الجلسة
// إذا لم توجد عربة، نستخدم مصفوفة فارغة
// =======================================================
$cart = $_SESSION['cart'] ?? [];

// =======================================================
// التحقق إذا كانت العربة فارغة
// لا يُسمح بتنفيذ الطلب بدون منتجات
// =======================================================
if (empty($cart)) {

    // تخزين رسالة خطأ في الجلسة لعرضها للمستخدم
    $_SESSION['flash'] = '❌ لا يمكن تنفيذ الطلب — العربة فارغة.';

    // إعادة توجيه المستخدم إلى صفحة العربة
    header('Location: ' . BASE_URL . 'cart.php');

    // إيقاف تنفيذ السكربت
    exit;
}

// =======================================================
// قراءة بيانات الفورم المرسلة عبر POST
// =======================================================

// اسم العميل (مع إزالة المسافات الزائدة)
$customer_name   = trim($_POST['customer_name'] ?? '');

// رقم الهاتف (مع إزالة المسافات الزائدة)
$customer_phone  = trim($_POST['customer_phone'] ?? '');

// طريقة الاستلام (توصيل أو استلام من نقطة)
// القيمة الافتراضية: توصيل
$delivery_method = $_POST['delivery_method'] ?? 'delivery';

// عنوان التوصيل
$address         = trim($_POST['address'] ?? '');

// موقع نقطة الاستلام
$pickup_location = trim($_POST['pickup_location'] ?? '');

// ملاحظات إضافية من المستخدم
$notes           = trim($_POST['notes'] ?? '');

// =======================================================
// التحقق من الحقول الإلزامية
// =======================================================
if ($customer_name === '' || $customer_phone === '') {

    // رسالة خطأ إذا لم يتم إدخال البيانات المطلوبة
    $_SESSION['flash'] = '❌ يرجى تعبئة جميع الحقول المطلوبة.';

    // إعادة المستخدم إلى صفحة checkout
    header('Location: ' . BASE_URL . 'checkout.php');

    // إيقاف التنفيذ
    exit;
}

// =======================================================
// بدء تنفيذ الطلب داخل try/catch
// لضمان سلامة البيانات في حال حدوث خطأ
// =======================================================
try {

    // بدء Transaction
    // أي خطأ لاحق سيؤدي إلى rollback
    $pdo->beginTransaction();

    // ===================================================
    // تجهيز معرفات المنتجات الموجودة في العربة
    // ===================================================

    // استخراج product_id من العربة وتحويلها لأرقام صحيحة
    $ids = array_map('intval', array_keys($cart));

    // إنشاء placeholders (?, ?, ?) حسب عدد المنتجات
    $in  = implode(',', array_fill(0, count($ids), '?'));

    // ===================================================
    // جلب بيانات المنتجات من قاعدة البيانات
    // ===================================================
    $stmt = $pdo->prepare(
        "SELECT id, name, price FROM products WHERE id IN ($in)"
    );

    // تمرير معرفات المنتجات للـ query
    $stmt->execute($ids);

    // جلب النتائج كمصفوفة
    $products = $stmt->fetchAll();

    // ===================================================
    // حساب المجموع الكلي للطلب
    // ===================================================
    $total = 0;

    // المرور على كل منتج
    foreach ($products as $p) {

        // جلب الكمية من العربة
        $qty = (int)$cart[$p['id']];

        // إضافة (السعر × الكمية) إلى الإجمالي
        $total += $p['price'] * $qty;
    }

    // ===================================================
    // إنشاء معرف الطلب (تعليمي)
    // ===================================================

    // مثال: COD-1700000000
    $gateway_order_id = 'COD-' . time();

    // ===================================================
    // إدخال الطلب في جدول orders
    // ===================================================
    $stmt = $pdo->prepare("
        INSERT INTO orders
        (user_id, gateway_order_id, status, currency, amount,
         customer_name, customer_phone, delivery_method,
         address, pickup_location, notes, created_at)
        VALUES
        (:uid, :goid, :status, 'USD', :amount,
         :name, :phone, :method,
         :addr, :pickup, :notes, NOW())
    ");


   // =======================================================
// تنفيذ إدخال الطلب في جدول orders
// =======================================================
$stmt->execute([
    // ربط معرف المستخدم الحالي بالطلب
    // الدالة current_user_id() ترجع id المستخدم من الجلسة
    ':uid'    => current_user_id(),

    // ربط معرف الطلب الخارجي (COD + timestamp)
    ':goid'   => $gateway_order_id,

    // حالة الطلب الافتراضية عند الإنشاء
    // هنا الطلب يكون بانتظار التأكيد
    ':status' => 'قيد التأكيد',

    // إجمالي مبلغ الطلب المحسوب مسبقًا
    ':amount' => $total,

    // اسم العميل
    ':name'   => $customer_name,

    // رقم هاتف العميل
    ':phone'  => $customer_phone,

    // طريقة الاستلام (توصيل أو استلام من نقطة)
    ':method' => $delivery_method,

    // عنوان التوصيل (قد يكون فارغ إذا كان استلام من نقطة)
    ':addr'   => $address,

    // موقع نقطة الاستلام (قد يكون فارغ إذا كان توصيل)
    ':pickup' => $pickup_location,

    // أي ملاحظات إضافية من العميل
    ':notes'  => $notes
]);

// =======================================================
// جلب رقم الطلب الذي تم إدخاله للتو
// هذا الرقم هو الـ AUTO_INCREMENT من جدول orders
// =======================================================
$order_id = $pdo->lastInsertId();

// =======================================================
// تجهيز statement لإدخال عناصر الطلب في order_items
// =======================================================
$stmtItem = $pdo->prepare("
    INSERT INTO order_items
    (order_id, product_id, name, qty, unit_price)
    VALUES (?, ?, ?, ?, ?)
");

// =======================================================
// إدخال كل منتج من العربة كسطر مستقل في order_items
// =======================================================
foreach ($products as $p) {

    // جلب كمية المنتج من العربة
    $qty = (int)$cart[$p['id']];

    // تنفيذ الإدخال
    $stmtItem->execute([
        // ربط المنتج بالطلب الأساسي
        $order_id,

        // معرف المنتج
        $p['id'],

        // اسم المنتج (يُحفظ كما هو وقت الطلب)
        $p['name'],

        // الكمية المطلوبة من هذا المنتج
        $qty,

        // سعر الوحدة وقت تنفيذ الطلب
        $p['price']
    ]);
}

// =======================================================
// إنهاء الـ Transaction بنجاح
// جميع العمليات السابقة تم حفظها في قاعدة البيانات
// =======================================================
$pdo->commit();

// =======================================================
// تفريغ العربة من الجلسة بعد تنفيذ الطلب
// =======================================================
unset($_SESSION['cart']);

// =======================================================
// تخزين رسالة نجاح لعرضها للمستخدم
// =======================================================
$_SESSION['flash'] = '✅ تم تنفيذ الطلب بنجاح!';

// =======================================================
// تحويل المستخدم إلى صفحة الشكر مع رقم الطلب
// =======================================================
header('Location: ' . BASE_URL . 'thankyou.php?order_id=' . $order_id);
exit;

// =======================================================
// في حال حدوث أي خطأ أثناء التنفيذ
// =======================================================
} catch (Throwable $e) {

    // إلغاء جميع العمليات التي تمت داخل Transaction
    $pdo->rollBack();

    // تسجيل الخطأ في سجل الأخطاء (logs)
    error_log($e->getMessage());

    // رسالة خطأ للمستخدم
    $_SESSION['flash'] = '⚠️ حدث خطأ أثناء تنفيذ الطلب.';

    // إعادة المستخدم إلى صفحة checkout
    header('Location: ' . BASE_URL . 'checkout.php');
    exit;
}
