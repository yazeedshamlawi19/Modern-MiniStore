<?php
/* =========================================================
   ุชุญููู ููู ุงูุฅุนุฏุงุฏุงุช ุงูุฑุฆูุณู
   ูุญุชูู ุนูู:
   - ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - BASE_URL
   - ุงูููุทูุฉ ุงูุฒูููุฉ
========================================================= */
require_once __DIR__ . '/config.php';

/* 
   ุจุฏุก ุงูุฌูุณุฉ ุฅุฐุง ูู ุชูู ููุนููุฉ
   ุงูุฌูุณุฉ ุชูุณุชุฎุฏู ููุนุฑูุฉ ุงููุณุชุฎุฏู ุงูุญุงูู
*/
if (session_status() === PHP_SESSION_NONE) session_start();

/* 
   ุชุญููู ููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
   ูุญุชูู ุนูู ุงูุฏุงูุฉ db()
*/
require_once __DIR__ . '/db.php';

/* 
   ุชุญููู ููู ุงูุชุญูู ูู ุงููุณุชุฎุฏู
   ูุญุชูู ุนูู:
   - is_logged_in()
   - current_user_id()
   - require_login()
*/
require_once __DIR__ . '/auth.php';

/* 
   ููุน ุงููุตูู ููุตูุญุฉ ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุณุฌูู ุฏุฎูู
   ูุชู ุชุญูููู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
*/
require_login();

/* 
   ุฅูุดุงุก ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู PDO
*/
$pdo = db();

/* 
   ูุตูููุฉ ูุชุฎุฒูู ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏู
*/
$orders = [];

/* 
   ูุตูููุฉ ูุชุฌููุน ุนูุงุตุฑ ูู ุทูุจ ุญุณุจ order_id
*/
$itemsByOrder = [];

/* 
   ุฌูุจ ุฑูู ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุงูุฌูุณุฉ
*/
$uid = current_user_id();

/* 
   ุชุญุถูุฑ ุงุณุชุนูุงู ูุฌูุจ ุฌููุน ุงูุทูุจุงุช
   ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏู ุงูุญุงูู ููุท
   ูุฑุชุจุฉ ูู ุงูุฃูุฏู ุฅูู ุงูุฃุญุฏุซ
*/
$stmt = $pdo->prepare(
  "SELECT * FROM orders 
   WHERE user_id = :uid 
   ORDER BY id ASC"
);

/* 
   ุชูููุฐ ุงูุงุณุชุนูุงู ูุน ุชูุฑูุฑ ุฑูู ุงููุณุชุฎุฏู
*/
$stmt->execute([':uid' => $uid]);

/* 
   ุฌูุจ ุฌููุน ุงูุทูุจุงุช ููุตูููุฉ
*/
$orders = $stmt->fetchAll(PDO::FETCH_ASSOC);

/* 
   ุฅุฐุง ูุงู ูุฏู ุงููุณุชุฎุฏู ุทูุจุงุช
   ูููู ุจุฌูุจ ุนูุงุตุฑ ูู ุทูุจ
*/
if ($orders) {

  /* 
     ุงุณุชุฎุฑุงุฌ ุฌููุน ุฃุฑูุงู ุงูุทูุจุงุช (id)
     ูู ูุตูููุฉ ุงูุทูุจุงุช
  */
  $ids = array_column($orders, 'id');

  /* 
     ุฅูุดุงุก ุนูุงูุงุช ุงุณุชููุงู (?, ?, ?)
     ุจุนุฏุฏ ุงูุทูุจุงุช ูุงุณุชุฎุฏุงููุง ูู IN()
  */
  $in = implode(',', array_fill(0, count($ids), '?'));

  /* 
     ุชุญุถูุฑ ุงุณุชุนูุงู ูุฌูุจ ุนูุงุตุฑ ุงูุทูุจุงุช
     ููู ุงูุทูุจุงุช ูุฑุฉ ูุงุญุฏุฉ
  */
  $stmt2 = $pdo->prepare(
    "SELECT * FROM order_items 
     WHERE order_id IN ($in)"
  );

  /* 
     ุชูููุฐ ุงูุงุณุชุนูุงู ูุชูุฑูุฑ ุฃุฑูุงู ุงูุทูุจุงุช
  */
  $stmt2->execute($ids);

  /* 
     ุชุฌููุน ุงูุนูุงุตุฑ ุจุญูุซ ุชุตุจุญ:
     $itemsByOrder[order_id][] = item
  */
  foreach ($stmt2->fetchAll(PDO::FETCH_ASSOC) as $it) {
    $itemsByOrder[$it['order_id']][] = $it;
  }
}

/* =========================================================
   ุฏุงูุฉ ููุนุงูุฌุฉ ุญุงูุฉ ุงูุทูุจ
   ุชุนูุฏ:
   - ุงุณู ููุงุณ CSS
   - ุงุณู ุงูุญุงูุฉ ุจุงูุนุฑุจู
========================================================= */
function order_status_meta(string $status): array {

  /* 
     ุชูุธูู ุงููุต ูุชุญูููู ูุญุฑูู ุตุบูุฑุฉ
  */
  $status = strtolower(trim($status));

  /* 
     ูุทุงุจูุฉ ุงูุญุงูุฉ ูุฅุฑุฌุงุน:
     [ุงุณู ุงูููุงุณ, ุงููุต ุงูุนุฑุจู]
  */
  return match ($status) {
    'pending_cod', 'pending'    => ['badge-pending', 'ููุฏ ุงูุชุฃููุฏ'],
    'processing', 'in_progress' => ['badge-processing', 'ููุฏ ุงูุชูููุฐ'],
    'completed', 'done'         => ['badge-completed', 'ููุชูู'],
    'cancelled', 'canceled'     => ['badge-cancelled', 'ููุบู'],

    /* 
       ุฃู ุญุงูุฉ ุบูุฑ ูุนุฑููุฉ
       ูุนุชุจุฑูุง ููุฏ ุงูุชุฃููุฏ
    */
    default                     => ['badge-neutral', 'ููุฏ ุงูุชุฃููุฏ'],
  };
}
?>

<!DOCTYPE html>
<!-- 
  ุชุนุฑูู ููุน ุงููุณุชูุฏ: HTML5
-->
<html lang="ar" dir="rtl">
<!-- 
  lang="ar" โ ูุบุฉ ุงูุตูุญุฉ ุนุฑุจูุฉ
  dir="rtl" โ ุงุชุฌุงู ุงููุชุงุจุฉ ูู ุงููููู ูููุณุงุฑ
-->
<head>
  <!-- 
    ุชุญุฏูุฏ ุชุฑููุฒ ุงูุฃุญุฑู
    UTF-8 ุถุฑูุฑู ูุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ
  -->
  <meta charset="UTF-8" />

  <!-- 
    ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุชููู ูุชุฌุงูุจุฉ ูุน ุงูุดุงุดุงุช ุงููุฎุชููุฉ
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 
    ุนููุงู ุงูุตูุญุฉ ุงูุฐู ูุธูุฑ ูู ุงููุชุตูุญ
  -->
  <title>ุทูุจุงุชู</title>

  <!-- 
    ุฑุจุท ููู ุงูุชูุณูู ุงูุนุงู ูููุดุฑูุน
  -->
  <link rel="stylesheet" href="assets/style.css" />

  <!-- 
    ุชูุณููุงุช ุฎุงุตุฉ ููุท ุจุตูุญุฉ "ุทูุจุงุชู"
  -->
  <style>

    /* 
      ุชูุณูู ุงูุนูุตุฑ ุงูุฑุฆูุณู main
      ุนุฑุถ ุงูุทูุจุงุช ุจุดูู ุนููุฏู ูุน ูุณุงูุงุช
    */
    main {
      display: grid;            /* ุงุณุชุฎุฏุงู Grid layout */
      gap: 22px;                /* ูุณุงูุฉ ุจูู ุงูุจุทุงูุงุช */
      margin: 40px auto;        /* ูุณุงูุฉ ุฎุงุฑุฌูุฉ ูู ุงูุฃุนูู + ุชูุณูุท */
      max-width: 900px;         /* ุฃูุตู ุนุฑุถ ูููุญุชูู */
    }

    /* 
      ูุฑุช ุงูุทูุจ ุงููุงุญุฏ
    */
    .order-card {
      background: linear-gradient(
        145deg,
        rgba(50, 20, 85, 0.9),
        rgba(70, 25, 110, 0.8)
      );                         /* ุฎูููุฉ ุจููุณุฌูุฉ ูุชุฏุฑุฌุฉ */
      border: 1px solid rgba(255,255,255,0.12); /* ุฅุทุงุฑ ุฎููู */
      border-radius: 18px;       /* ุฒูุงูุง ุฏุงุฆุฑูุฉ */
      padding: 22px;             /* ูุณุงูุฉ ุฏุงุฎููุฉ */
      color: #fff;               /* ููู ุงููุต ุฃุจูุถ */
      box-shadow: 0 10px 25px rgba(0,0,0,0.25); /* ุธู ูููุฑุช */
      transition: transform 0.3s ease,
                  box-shadow 0.3s ease;        /* ุญุฑูุฉ ูุงุนูุฉ */
    }

    /* 
      ุชุฃุซูุฑ ุนูุฏ ุชูุฑูุฑ ุงููุงูุณ ููู ูุฑุช ุงูุทูุจ
    */
    .order-card:hover {
      transform: translateY(-4px);             /* ุฑูุน ุจุณูุท */
      box-shadow: 0 12px 30px rgba(150, 90, 255, 0.25); /* ุธู ุฃููู */
    }

    /* 
      ุฑุฃุณ ุงูุทูุจ (ุฑูู ุงูุทูุจ + ุงูุชุงุฑูุฎ)
    */
    .order-header {
      display: flex;            /* ุชุฑุชูุจ ุฃููู */
      justify-content: space-between; /* ุชูุฒูุน ุงูุนูุงุตุฑ */
      align-items: center;      /* ูุญุงุฐุงุฉ ุนููุฏูุฉ */
      margin-bottom: 8px;       /* ูุณุงูุฉ ุฃุณูู */
    }

    /* 
      ุนููุงู ุงูุทูุจ (ุทูุจ ุฑูู X)
    */
    .order-header h3 {
      margin: 0;
      font-size: 18px;
      color: #d6c9e6;           /* ุจููุณุฌู ูุงุชุญ */
    }

    /* 
      ุงูุดุงุฑุฉ ุงูุฎุงุตุฉ ุจุญุงูุฉ ุงูุทูุจ
    */
    .badge {
      display: inline-flex;     /* ุชุฑุชูุจ ุฃููู */
      align-items: center;
      gap: 8px;                 /* ูุณุงูุฉ ุจูู ุงูุฏุงุฆุฑุฉ ูุงููุต */
      padding: 6px 12px;
      border-radius: 999px;     /* ุดูู ูุจุณููุฉ */
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .2px;
      border: 1px solid transparent;
    }

    /* 
      ุญุงูุฉ: ููุฏ ุงูุชุฃููุฏ
    */
    .badge-pending {
      background: rgba(250, 204, 21, .15);
      color: #fde68a;
      border-color: rgba(250, 204, 21, .35);
    }

    /* 
      ุญุงูุฉ: ููุชูู
    */
    .badge-completed {
      background: rgba(16, 185, 129, .15);
      color: #a7f3d0;
      border-color: rgba(16,185,129,.35);
    }

    /* 
      ุญุงูุฉ: ููุบู
    */
    .badge-cancelled {
      background: rgba(239, 68, 68, .15);
      color: #fecaca;
      border-color: rgba(239,68,68,.35);
    }

    /* 
      ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ
    */
    .badge-neutral {
      background: rgba(250, 204, 21, .15);
      color: #fde68a;
      border-color: rgba(250, 204, 21, .35);
    }

    /* 
      ุงูุฏุงุฆุฑุฉ ุงูุตุบูุฑุฉ ูุจู ูุต ุงูุญุงูุฉ
    */
    .badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor; /* ููุณ ููู ุงููุต */
      opacity: .85;
      box-shadow: 0 0 10px currentColor;
    }

    /* 
      ูุงุฆูุฉ ุนูุงุตุฑ ุงูุทูุจ
    */
    ul.order-items {
      list-style: none;         /* ุฅุฒุงูุฉ ุงูููุงุท */
      padding: 0;
      margin: 8px 0 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* 
      ุนูุตุฑ ูุงุญุฏ ุฏุงุฎู ุงูุทูุจ
    */
    ul.order-items li {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      color: #eee;
    }

    /* 
      ุณุทุฑ ุฅุฌูุงูู ุงูุทูุจ
    */
    .total-line {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 15px;
      margin-top: 8px;
    }

    /* 
      ูุนูููุงุช ุงูุชูุตูู ุฃู ุงูุงุณุชูุงู
    */
    .delivery-info {
      margin-top: 6px;
      font-size: 14px;
      color: #cbbbee;
    }

    /* 
      ูุต ุซุงููู ุจููู ูุงุฏุฆ
    */
    .muted {
      color: #bdaedb;
    }

  </style>
</head>
<body>
<!-- 
  ุจุฏุงูุฉ ุฌุณู ุงูุตูุญุฉ
-->

<header class="container">
  <!-- 
    ุฑุฃุณ ุงูุตูุญุฉุ ูุญุชูู ุนููุงู ุงูุตูุญุฉ ูุดุฑูุท ุงูุชููู
  -->

  <h1>๐งพ ุทูุจุงุชู</h1>
  <!-- 
    ุนููุงู ุงูุตูุญุฉ ุงูุธุงูุฑ ูููุณุชุฎุฏู
  -->

  <nav>
    <!-- 
      ุฑูุงุจุท ุงูุชููู ุงูุฃุณุงุณูุฉ ุฏุงุฎู ุงููููุน
    -->

    <a href="index.php">ุงูููุชุฌุงุช</a>
    <!-- 
      ุฑุงุจุท ุงูุนูุฏุฉ ูุตูุญุฉ ุนุฑุถ ุงูููุชุฌุงุช
    -->

    <a href="cart.php">ุงูุนุฑุจุฉ</a>
    <!-- 
      ุฑุงุจุท ุตูุญุฉ ุนุฑุจุฉ ุงูุชุณูู
    -->

    <a href="my_orders.php">ุทูุจุงุชู</a>
    <!-- 
      ุฑุงุจุท ุตูุญุฉ ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏู ุงูุญุงูู
    -->

    <?php if (is_admin()): ?>
      <!-- 
        ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ุฃุฏูู
        ูุชู ุฅุธูุงุฑ ุฑูุงุจุท ุฎุงุตุฉ ุจุงูุฅุฏุงุฑุฉ
      -->
      <a href="orders.php">ุงูุทูุจุงุช (ูุณุคูู)</a>
      <!-- 
        ุฑุงุจุท ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุทูุจุงุช
      -->
      <a href="admin_logout.php">ุฎุฑูุฌ (ูุณุคูู)</a>
      <!-- 
        ุชุณุฌูู ุฎุฑูุฌ ุงูุฃุฏูู
      -->
    <?php endif; ?>

    <?php if (is_logged_in()): ?>
      <!-- 
        ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ูุณุฌูู ุฏุฎูู
      -->
      <span class="muted">
        ูุฑุญุจุงูุ <?= htmlspecialchars($_SESSION['user']['name']) ?>
      </span>
      <!-- 
        ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ุงูุญุงูู ุจุดูู ุขูู
      -->
      <a href="user_logout.php">ุฎุฑูุฌ</a>
      <!-- 
        ุฑุงุจุท ุชุณุฌูู ุงูุฎุฑูุฌ
      -->
    <?php else: ?>
      <!-- 
        ูู ุญุงู ูู ููู ุงููุณุชุฎุฏู ูุณุฌูู ุฏุฎูู
      -->
      <a href="user_login.php">ุฏุฎูู</a>
      <!-- 
        ุฑุงุจุท ุชุณุฌูู ุงูุฏุฎูู
      -->
      <a href="user_register.php">ุชุณุฌูู</a>
      <!-- 
        ุฑุงุจุท ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
      -->
    <?php endif; ?>
  </nav>
</header>

<main>
  <!-- 
    ุงููุญุชูู ุงูุฑุฆูุณู ููุตูุญุฉ
  -->

  <?php if (!$orders): ?>
    <!-- 
      ูู ุญุงู ูู ููู ูุฏู ุงููุณุชุฎุฏู ุฃู ุทูุจุงุช
    -->
    <p style="text-align:center; color:var(--muted); margin-top:40px;">
      ูุง ุชูุฌุฏ ุทูุจุงุช ููุนุฑุถ ุญุงููุงู.
    </p>
  <?php else: ?>
    <!-- 
      ูู ุญุงู ูุฌูุฏ ุทูุจุงุช
    -->

    <?php $i = 1; foreach ($orders as $o): ?>
      <!-- 
        ุญููุฉ ุชูุฑ ุนูู ุฌููุน ุทูุจุงุช ุงููุณุชุฎุฏู
        $i โ ุฑูู ุชุณูุณูู ููุนุฑุถ ููุท
      -->

      <?php
        // ุชุญุฏูุฏ ููู ูุงุณู ุงูุญุงูุฉ ุจูุงุกู ุนูู ุญุงูุฉ ุงูุทูุจ
        [$stClass, $stLabel] = order_status_meta($o['status'] ?? '');
      ?>

      <section class="order-card reveal-in">
        <!-- 
          ูุฑุช ููุซู ุทูุจ ูุงุญุฏ
        -->

        <div class="order-header">
          <!-- 
            ุฑุฃุณ ุงูุทูุจ (ุฑูู ุงูุทูุจ + ุชุงุฑูุฎ ุงูุฅูุดุงุก)
          -->
          <h3>ุทูุจ ุฑูู <?= $i++; ?></h3>
          <!-- 
            ุฑูู ุชุณูุณูู ููุทูุจ (ููุนุฑุถ ููุท)
          -->
          <span class="muted">
            <?= htmlspecialchars($o['created_at']); ?>
          </span>
          <!-- 
            ุชุงุฑูุฎ ุฅูุดุงุก ุงูุทูุจ
          -->
        </div>

        <div class="badge <?= $stClass; ?>">
          <?= htmlspecialchars($stLabel); ?>
        </div>
        <!-- 
          ุดุงุฑุฉ ุญุงูุฉ ุงูุทูุจ (ููุฏ ุงูุชุฃููุฏ / ููุชูู / ููุบู ...)
        -->

        <ul class="order-items">
          <!-- 
            ูุงุฆูุฉ ุนูุงุตุฑ ุงูุทูุจ
          -->
          <?php foreach ($itemsByOrder[$o['id']] ?? [] as $it): ?>
            <!-- 
              ุญููุฉ ุชูุฑ ุนูู ุนูุงุตุฑ ูุฐุง ุงูุทูุจ
            -->
            <li>
              <span>
                <?= htmlspecialchars($it['name']); ?> ร <?= (int)$it['qty']; ?>
              </span>
              <!-- 
                ุงุณู ุงูููุชุฌ + ุงููููุฉ
              -->
              <strong>
                <?= number_format((float)$it['unit_price'] * (int)$it['qty'], 2); ?> USD
              </strong>
              <!-- 
                ุณุนุฑ ูุฐุง ุงูููุชุฌ ร ุงููููุฉ
              -->
            </li>
          <?php endforeach; ?>
        </ul>

        <div class="total-line">
          <!-- 
            ุณุทุฑ ุฅุฌูุงูู ุงูุทูุจ
          -->
          <span>ุงูุฅุฌูุงูู:</span>
          <strong>
            <?= number_format((float)$o['amount'], 2); ?> USD
          </strong>
        </div>

        <div class="delivery-info">
          <!-- 
            ูุนูููุงุช ุทุฑููุฉ ุงูุงุณุชูุงู
          -->
          ุทุฑููุฉ ุงูุงุณุชูุงู:
          <strong>
            <?= $o['delivery_method'] === 'pickup' ? 'ุงุณุชูุงู ูู ููุทุฉ' : 'ุชูุตูู'; ?>
          </strong>

          <?php if ($o['delivery_method'] === 'pickup' && $o['pickup_location']): ?>
            <!-- 
              ูู ุญุงู ูุงู ุงูุงุณุชูุงู ูู ููุทุฉ
            -->
            โ ุงูููุทุฉ: <?= htmlspecialchars($o['pickup_location']); ?>
          <?php elseif ($o['delivery_method'] === 'delivery' && $o['address']): ?>
            <!-- 
              ูู ุญุงู ูุงู ุงูุชูุตูู
            -->
            โ ุงูุนููุงู: <?= htmlspecialchars($o['address']); ?>
          <?php endif; ?>
        </div>
      </section>

    <?php endforeach; ?>
  <?php endif; ?>
</main>

<script>
/*
  ุนูุฏ ุชุญููู ุงูุตูุญุฉ:
  ูุชู ุฅุธูุงุฑ ูุฑูุช ุงูุทูุจุงุช ุจุชุฃุซูุฑ ุชุฏุฑูุฌู
*/
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.order-card').forEach((c, i) => {
    setTimeout(() => c.classList.add('reveal-in'), 120 * (i + 1));
  });
});
</script>

</body>
</html>
