<?php
// ุชุญููู ููู ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ (ูุงุนุฏุฉ ุงูุจูุงูุงุช + BASE_URL + timezone ... ุฅูุฎ)
require_once __DIR__ . '/../config.php';

// ุชุญููู ููู db.php ุงูุฐู ูุญุชูู ุฏุงูุฉ db() ููุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
require_once __DIR__ . '/../db.php';

// ุชุญุฏูุฏ ููุน ุงูุงุณุชุฌุงุจุฉ ูููุชุตูุญ ุฃู JavaScript ุฃููุง JSON ูุจุชุฑููุฒ UTF-8 ูุฏุนู ุงูุนุฑุจูุฉ
header('Content-Type: application/json; charset=utf-8');

try {
  // ุฅูุดุงุก ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ db()
  $pdo = db();

  // ุถุจุท ุฅุนุฏุงุฏ PDO ุจุญูุซ ูุฑูู Exceptions ุนูุฏ ุญุฏูุซ ุฎุทุฃ ุจุฏู ูุง ูุฑุฌุน false
  $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

  // ูุนุฑูุฉ ููุน ุงูุทูุจ ุงูุญุงูู (GET ุฃู POST ุฃู DELETE) ุงููุงุฏู ูู ุงููุชุตูุญ/JavaScript
  $method = $_SERVER['REQUEST_METHOD'];

  // ุงุณุชุฎุฏุงู switch ูุชุญุฏูุฏ ูุงุฐุง ููุนู ุจูุงุกู ุนูู ููุน ุงูุทูุจ
  switch ($method) {
 
    // ุฅุฐุง ูุงู ุงูุทูุจ GET (ูุนูู ุงููุทููุจ ุนุงุฏุฉ ุฌูุจ ุงูููุชุฌุงุช)
    case 'GET':

      // ุชูููุฐ ุงุณุชุนูุงู SQL ูุฌูุจ ุฃุนูุฏุฉ ูุญุฏุฏุฉ ูู ุฌุฏูู ุงูููุชุฌุงุช ูุชุฑุชูุจูุง ูู ุงูุฃุญุฏุซ ููุฃูุฏู
      $stmt = $pdo->query("SELECT id, name, price, stock, image_url FROM products ORDER BY id DESC");

      // ุฌูุจ ูู ุงููุชุงุฆุฌ ูู ุงูุงุณุชุนูุงู ููุตูููุฉ Associative Array
      $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

      // ุชุญููู ุงููุตูููุฉ ุฅูู JSON ูุฅุฑุณุงููุง ูููุงุฌูุฉ ูุน ุงูุญูุงุธ ุนูู ุงูุญุฑูู ุงูุนุฑุจูุฉ ุจุฏูู ุชุญููููุง ูุฑููุฒ Unicode
      echo json_encode($products, JSON_UNESCAPED_UNICODE);

      // ุฅููุงุก ุชูููุฐ ุญุงูุฉ GET
      break;


    // ุฅุฐุง ูุงู ุงูุทูุจ POST (ูุนูู ุฅุถุงูุฉ ููุชุฌ ุฃู ุชุนุฏูู ููุชุฌ)
    case 'POST':
   
      // ูุฑุงุกุฉ ุงุณู ุงูุฅุฌุฑุงุก action ูู POSTุ ุฅุฐุง ูู ููุฑุณู ูุนุชุจุฑ ุงูุชุฑุงุถููุง "save"
      $action = $_POST['action'] ?? 'save';

      // ูุฑุงุกุฉ id ุฅุฐุง ููุฌูุฏ ูุชุญูููู ูุฑูู ุตุญูุญุ ูุฅุฐุง ุบูุฑ ููุฌูุฏ ูุตุจุญ null
      $id     = isset($_POST['id']) ? (int)$_POST['id'] : null;

      // ูุฑุงุกุฉ ุงุณู ุงูููุชุฌ ูุฅุฒุงูุฉ ุงููุฑุงุบุงุช ูู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ (trim)
      $name   = trim($_POST['name'] ?? '');

      // ูุฑุงุกุฉ ุงูุณุนุฑ ูุชุญูููู ูุฑูู ุนุดุฑู float (ุญุชู ูู ูุงู ูุต)
      $price  = floatval($_POST['price'] ?? 0);

      // ูุฑุงุกุฉ ุงููุฎุฒูู ูุชุญูููู ูุฑูู ุตุญูุญ int
      $stock  = intval($_POST['stock'] ?? 0);

      // ูุฑุงุกุฉ ุฑุงุจุท ุงูุตูุฑุฉ (ุฅุฐุง ููุฌูุฏ) ูุฅุฒุงูุฉ ุงููุฑุงุบุงุช ููู
      $image_url = trim($_POST['image_url'] ?? '');

      // ุชุญูู: ุฅุฐุง ุงูุงุณู ูุงุถู ุฃู ุงูุณุนุฑ <= 0ุ ูุฑุฌุน ุฎุทุฃ ููุนููู ูุฃู ุจูุงูุงุช ุงูููุชุฌ ุบูุฑ ุตุญูุญุฉ
      if ($name === '' || $price <= 0) {

        // ุฅุฑุณุงู ููุฏ HTTP 400 ูุนูู "Bad Request"
        http_response_code(400);

        // ุฅุฑุณุงู ุฑุณุงูุฉ ุฎุทุฃ ุจุตูุบุฉ JSON ูููุงุฌูุฉ
        echo json_encode(['error' => 'โ๏ธ ุจูุงูุงุช ุงูููุชุฌ ุบูุฑ ุตุงูุญุฉ.']);

        // ุฅููุงุก ุชูููุฐ ุงูููู ููุฑูุง ูุฃู ุงูุทูุจ ุบูุฑ ุตุญูุญ
        exit;
      }

      // ุชุญูู: ูู ุชู ุฅุฑุณุงู ููู ุตูุฑุฉ ูุนูููุง ูู ุงูููุฑูุ (ูุฌูุฏ tmp_name ูุนูู ุชู ุฑูุน ููู)
      if (!empty($_FILES['image']['tmp_name'])) {

        // ุชุญุฏูุฏ ูุณุงุฑ ูุฌูุฏ ุงูุฑูุน uploads ุฏุงุฎู ุงููุดุฑูุน (ูู ุฌุฐุฑ ุงููุดุฑูุน ูููุณ ุฏุงุฎู api)
        $uploadDir = __DIR__ . '/../uploads/';

        // ุฅุฐุง ุงููุฌูุฏ ุบูุฑ ููุฌูุฏุ ููุดุฆู (0777 ุตูุงุญูุงุช ูุงุณุนุฉ) ูุน true ูุฅูุดุงุก ูุฌูุฏุงุช ูุชุฏุงุฎูุฉ ุฅุฐุง ูุฒู
        if (!is_dir($uploadDir)) mkdir($uploadDir, 0777, true);

        // ุฅูุดุงุก ุงุณู ููู ุฌุฏูุฏ ูุฑูุฏ uniqid + ุงุณู ุงูููู ุงูุฃุตูู basename ูุญูุงูุฉ ุงููุณุงุฑ
        $filename = uniqid() . '-' . basename($_FILES['image']['name']);

        // ุงููุณุงุฑ ุงูููุงุฆู ุงูุฐู ุณูุชู ุญูุธ ุงูุตูุฑุฉ ููู ุฏุงุฎู ุงูุณูุฑูุฑ
        $targetPath = $uploadDir . $filename;

        // ููู ุงูููู ูู ููุงูู ุงููุคูุช ุฅูู ุงูููุงู ุงูููุงุฆู ุฏุงุฎู uploads
        if (move_uploaded_file($_FILES['image']['tmp_name'], $targetPath)) {

          // ุจุนุฏ ุงููุฌุงุญ: ูุญูุธ ุฑุงุจุท ุงูุตูุฑุฉ ูู URL ูุงูู ุญุชู ูุธูุฑ ูู ุงููููุน
          $image_url = BASE_URL . 'uploads/' . $filename;
        }
      }

   
      // ุฅุฐุง ุงูุฅุฌุฑุงุก create ุฃู ุฅุฐุง ูุง ููุฌุฏ idุ ููุฐุง ูุนูู "ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ"
      if ($action === 'create' || !$id) {

        // ุชุฌููุฒ ุงุณุชุนูุงู INSERT ุจุงุณุชุฎุฏุงู prepared statement ููุญูุงูุฉ ูู SQL Injection
        $stmt = $pdo->prepare("INSERT INTO products (name, price, stock, image_url) VALUES (?, ?, ?, ?)");

        // ุชูููุฐ ุงูุงุณุชุนูุงู ูุฅุฑุณุงู ุงูููู ุจุงูุชุฑุชูุจ
        $stmt->execute([$name, $price, $stock, $image_url]);

        // ุฅุฑุณุงู ูุชูุฌุฉ ูุฌุงุญ ูููุงุฌูุฉ ุจุตูุบุฉ JSON
        echo json_encode(['success' => true, 'message' => 'โ ุชู ุฅุถุงูุฉ ุงูููุชุฌ ุจูุฌุงุญ']);

        // ุฅููุงุก ุงูุชูููุฐ ูุฃู ุงูุนูููุฉ ุชูุช
        exit;
      }

      // ุฅุฐุง ุงูุฅุฌุฑุงุก update ูููุฌุฏ id ููุฐุง ูุนูู ุชุนุฏูู ููุชุฌ ููุฌูุฏ
      if ($action === 'update' && $id) {

        // ุชุฌููุฒ ุงุณุชุนูุงู UPDATE ูุชุนุฏูู ุจูุงูุงุช ุงูููุชุฌ ุจูุงุกู ุนูู id
        $stmt = $pdo->prepare("UPDATE products SET name=?, price=?, stock=?, image_url=? WHERE id=?");

        // ุชูููุฐ ุงูุงุณุชุนูุงู ุจุงูููู (ูุงุญุธ id ูู ุงูููุงูุฉ ูุฃูู ุดุฑุท WHERE)
        $stmt->execute([$name, $price, $stock, $image_url, $id]);

        // ุฅุฑุณุงู ุฑุณุงูุฉ ูุฌุงุญ ูููุงุฌูุฉ ุจุตูุบุฉ JSON
        echo json_encode(['success' => true, 'message' => 'โ ุชู ุชุญุฏูุซ ุงูููุชุฌ']);

        // ุฅููุงุก ุงูุชูููุฐ ูุฃู ุงูุชุญุฏูุซ ุชู
        exit;
      }

      // ุฅุฐุง ูู ูุชุญูู create ููุง updateุ ูุฑุณู ุฑุณุงูุฉ ุชููุฏ ุฃูู ูู ูุชู ุชูููุฐ ุดูุก
      echo json_encode(['success' => false, 'message' => 'โ ูู ูุชู ุชูููุฐ ุฃู ุฅุฌุฑุงุก']);

      // ุฅููุงุก ุญุงูุฉ POST
      break;

  
   // ุฅุฐุง ูุงู ุงูุทูุจ DELETE (ุญุฐู ููุชุฌ)
   case 'DELETE':

  // ูุฑุงุกุฉ ูุญุชูู body ููุทูุจ DELETE ูุชุญูููู ููุตูููุฉ ุฏุงุฎู $_DELETE
  parse_str(file_get_contents("php://input"), $_DELETE);

  // ูุญุงููุฉ ุฌูุจ id ุฅูุง ูู $_GET ุฃู ูู body ุงููุญูู ูู $_DELETEุ ูุฅุฐุง ูุง ููุฌุฏ ูุตุจุญ 0
  $id = intval($_GET['id'] ?? ($_DELETE['id'] ?? 0));

  // ุฅุฐุง id ุบูุฑ ููุฌูุฏ ุฃู 0ุ ูุฐุง ูุนูู ุฃูู ุบูุฑ ุตุงูุญ ููุญุฐู
  if (!$id) {

    // ุฅุฑุณุงู ููุฏ 400 ูุฃู ุงูุทูุจ ุณูุก (id ุบูุฑ ููุฌูุฏ)
    http_response_code(400);

    // ุฅุฑุณุงู ุฑุณุงูุฉ ุฎุทุฃ ุจุตูุบุฉ JSON
    echo json_encode(['error' => 'โ๏ธ ูุนุฑู ุงูููุชุฌ ุบูุฑ ุตุงูุญ.']);

    // ุฅููุงุก ุงูุชูููุฐ ูุฃู ุญุฐู ุจุฏูู id ูุง ูููู
    exit;
  }

  // ุชุฌููุฒ ุงุณุชุนูุงู DELETE ูุญุฐู ุงูููุชุฌ ุงูุฐู ูุญูู id ุงููุญุฏุฏ
  $stmt = $pdo->prepare("DELETE FROM products WHERE id=?");

  // ุชูููุฐ ุงูุงุณุชุนูุงู ูุฅุฑุณุงู id
  $stmt->execute([$id]);

  // ุฅุฑุณุงู ุฑุณุงูุฉ ูุฌุงุญ ุจุนุฏ ุงูุญุฐู
  echo json_encode(['success' => true, 'message' => '๐๏ธ ุชู ุญุฐู ุงูููุชุฌ ุจูุฌุงุญ']);

  // ุฅููุงุก ุญุงูุฉ DELETE
  break;


  
    // ุฅุฐุง ุฌุงุก ููุน ุทูุจ ุบูุฑ GET/POST/DELETE
    default:

      // ุฅุฑุณุงู ููุฏ 405 ูุนูู "Method Not Allowed"
      http_response_code(405);

      // ุฅุฑุณุงู ุฑุณุงูุฉ ุฎุทุฃ ุจุตูุบุฉ JSON
      echo json_encode(['error' => 'ุทุฑููุฉ ุงูุทูุจ ุบูุฑ ูุณููุญุฉ.']);
  }

} catch (Throwable $e) {
  // ูู ุญุงู ุตุงุฑ ุฎุทุฃ ุบูุฑ ูุชููุน (ูุงุนุฏุฉ ุจูุงูุงุชุ ููุฏุ ุฅูุฎ) ูุฑุฌุน 500
  http_response_code(500);

  // ุฅุฑุณุงู ุฑุณุงูุฉ ุชูุถุญ ุฃูู ุฎุทุฃ ุณูุฑูุฑ ูุน ุฑุณุงูุฉ ุงูุฎุทุฃ (ูููุฏ ุฃุซูุงุก ุงูุชุทููุฑ)
  echo json_encode(['error' => 'ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู: ' . $e->getMessage()]);
}
