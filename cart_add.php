<?php
// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ BASE_URLØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©...)
require_once __DIR__ . '/config.php';

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø­ØªÙ‰ Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… $_SESSION
if (session_status() === PHP_SESSION_NONE) session_start();

// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
require_once __DIR__ . '/db.php';

// ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (is_logged_in ÙˆØºÙŠØ±Ù‡Ø§)
require_once __DIR__ . '/auth.php';


// Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„
if (!is_logged_in()) {

  // ØªØ®Ø²ÙŠÙ† Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
  $_SESSION['flash'] = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø©.';

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  header('Location: user_login.php');

  // Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ù Ø­ØªÙ‰ Ù„Ø§ ÙŠØ³ØªÙ…Ø± Ø§Ù„ÙƒÙˆØ¯
  exit;
}


// Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ id Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· (GET)
if (empty($_GET['id'])) {

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  header('Location: index.php');

  // Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ù
  exit;
}

// ØªØ­ÙˆÙŠÙ„ id Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ù‚Ù… ØµØ­ÙŠØ­
$product_id = (int)$_GET['id'];


// Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
$pdo = db();

// ØªØ¬Ù‡ÙŠØ² Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
$stmt = $pdo->prepare("SELECT id, name, price, stock FROM products WHERE id = ?");

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¹ ØªÙ…Ø±ÙŠØ± id Ø§Ù„Ù…Ù†ØªØ¬
$stmt->execute([$product_id]);

// Ø¬Ù„Ø¨ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙƒÙ€ associative array
$product = $stmt->fetch(PDO::FETCH_ASSOC);

// Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if (!$product) {

  // ØªØ®Ø²ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
  $_SESSION['flash'] = 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.';

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  header('Location: index.php');

  // Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ù
  exit;
}


// Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¹Ø±Ø¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
if (!isset($_SESSION['cart'])) {

  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
  $_SESSION['cart'] = [];
}


// Ø§Ù„ØªØ­Ù‚Ù‚: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©
if (isset($_SESSION['cart'][$product_id])) {

  // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ù…Ù‚Ø¯Ø§Ø± 1
  $_SESSION['cart'][$product_id]++;

} else {

  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©ØŒ Ù†Ø¶ÙŠÙÙ‡ Ø¨ÙƒÙ…ÙŠØ© 1
  $_SESSION['cart'][$product_id] = 1;
}


// ØªØ®Ø²ÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ ØªØ­ØªÙˆÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø¶Ø§Ù
$_SESSION['flash'] = "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {$product['name']} Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨Ø© ðŸ›’";


// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¨Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
header('Location: cart.php');

// Ø¥ÙŠÙ‚Ø§Ù ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
exit;
?>
