<?php
// ุชุญููู ููู config.php ูุฑุฉ ูุงุญุฏุฉ ููุท
// ูุฐุง ุงูููู ูุญุชูู ุนูู ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ ูุซู:
// - ุจูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
// - BASE_URL
// - ุฅุนุฏุงุฏุงุช ุงูููุทูุฉ ุงูุฒูููุฉ
require_once __DIR__ . '/config.php';

// ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุฌูุณุฉ ุบูุฑ ููุนููุฉ
// PHP_SESSION_NONE ูุนูู ุฃูู ูู ูุชู ุจุฏุก session ุจุนุฏ
// ูู ูุฐู ุงูุญุงูุฉ ูููู ุจุชุดุบูู session_start()
// ุงูุฌูุณุฉ ุชุณุชุฎุฏู ูุชุฎุฒูู:
// - ุจูุงูุงุช ุงููุณุชุฎุฏู
// - ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู
// - ุญุงูุฉ ุงูุฃุฏูู
if (session_status() === PHP_SESSION_NONE) session_start();

// ุชุญููู ููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
// db.php ูุญุชูู ุนูู ุฏุงูุฉ db()
// ูุฐู ุงูุฏุงูุฉ ุชูุฑุฌุน ูุงุฆู PDO ุฌุงูุฒ ููุชุนุงูู ูุน MySQL
require_once __DIR__ . '/db.php';

// ุชุญููู ููู ุงูุชุญูู ูุงูุตูุงุญูุงุช
// auth.php ูุญุชูู ุนูู ุฏูุงู ูุซู:
// - is_logged_in()
// - is_admin()
// - require_login()
require_once __DIR__ . '/auth.php';
?>

<!DOCTYPE html>
<!-- ุจุฏุงูุฉ ูุณุชูุฏ HTML -->
<!-- ุงููุบุฉ ุนุฑุจูุฉ (lang="ar") -->
<!-- ุงุชุฌุงู ุงูุตูุญุฉ ูู ุงููููู ูููุณุงุฑ (dir="rtl") -->
<html lang="ar" dir="rtl">
<head>
  <!-- ุชุญุฏูุฏ ุชุฑููุฒ ุงูุฃุญุฑู UTF-8 -->
  <!-- ุถุฑูุฑู ูุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ ุจุดูู ุตุญูุญ -->
  <meta charset="UTF-8" />

  <!-- ุฅุนุฏุงุฏุงุช ุงูุงุณุชุฌุงุจุฉ ููุดุงุดุงุช ุงููุฎุชููุฉ -->
  <!-- ูุฌุนู ุงููููุน ููุงุณุจูุง ููุฌูุงู ูุงูุชุงุจูุช -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ุนููุงู ุงูุตูุญุฉ ุงูุฐู ูุธูุฑ ูู ุงููุชุตูุญ -->
  <title>๐๏ธ Modern MiniStore</title>

  <!-- ุฑุจุท ููู CSS ุงูุฎุงุฑุฌู -->
  <!-- ูุญุชูู ุนูู ุงูุชุตููู ุงูุนุงู ูููููุน -->
  <link rel="stylesheet" href="assets/style.css" />

  <!-- ุชูุฑูุฑ ูุชุบูุฑุงุช ูู PHP ุฅูู JavaScript -->
  <script>
    // ูุชุบูุฑ ูุญุฏุฏ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุงูุญุงูู ุฃุฏูู
    // is_admin() ุชุฑุฌุน true ุฃู false
    // ูุญูููุง ููููุฉ JavaScript ุญููููุฉ
    window.IS_ADMIN = <?php echo is_admin() ? 'true' : 'false'; ?>;

    // ูุชุบูุฑ ูุญุฏุฏ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
    // ููุญุต ูุฌูุฏ user id ุฏุงุฎู ุงูุฌูุณุฉ
    window.IS_LOGGED = <?php echo !empty($_SESSION['user']['id']) ? 'true' : 'false'; ?>;
  </script>

  <!-- ุชุญููู ููู JavaScript ุงูุฑุฆูุณู -->
  <!-- defer ูุนูู ูุชู ุชุญูููู ุจุนุฏ ุงูุชูุงู HTML -->
  <script src="assets/app.js" defer></script>

  <!-- ุชูุณููุงุช CSS ุฏุงุฎููุฉ ุฎุงุตุฉ ุจูุฐู ุงูุตูุญุฉ -->
  <style>
    /* ุชูุณูู ุฌุณู ุงูุตูุญุฉ ุจุงููุงูู */
    body {
      /* ุฎูููุฉ ูุชุฏุฑุฌุฉ ุจุงูููู ุงูุจููุณุฌู */
      background: linear-gradient(135deg, #4b0082, #7a2ff7);

      /* ููู ุงููุต */
      color: #fff;

      /* ุงูุฎุท ุงููุณุชุฎุฏู */
      font-family: "Cairo", sans-serif;

      /* ุฅุฒุงูุฉ ุงูููุงูุด ุงูุงูุชุฑุงุถูุฉ */
      margin: 0;
      padding: 0;

      /* ุถูุงู ุฃู ุงูุตูุญุฉ ุชููุฃ ูุงูู ุงูุดุงุดุฉ */
      min-height: 100vh;
    }

    /* ุชูุณูู ุงูููุฏุฑ ุงูุฑุฆูุณู */
    header.container {
      display: flex;

      /* ุชูุฒูุน ุงูุนูุงุตุฑ (ุงูุนููุงู + ุงููุงุฆูุฉ) */
      justify-content: space-between;
      align-items: center;

      /* ูุณุงูุงุช ุฏุงุฎููุฉ */
      padding: 20px 30px;

      /* ุฎูููุฉ ุดูุงูุฉ */
      background: rgba(255,255,255,0.1);

      /* ุชุฃุซูุฑ ุถุจุงุจู */
      backdrop-filter: blur(6px);

      /* ุฎุท ูุงุตู ุฃุณูู ุงูููุฏุฑ */
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }

    /* ุชูุณูู ุนููุงู ุงููุชุฌุฑ ุฏุงุฎู ุงูููุฏุฑ */
    header h1 {
      font-size: 1.6rem;
      margin: 0;

      /* ุชุฑุชูุจ ุงูุฃููููุฉ ูุงููุต */
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ุชูุณูู ุฑูุงุจุท ุงููุงุฆูุฉ */
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 8px;
      padding: 6px 12px;
      border-radius: 8px;

      /* ุฎูููุฉ ุดูุงูุฉ ููุฑุงุจุท */
      background: rgba(255,255,255,0.1);

      /* ุญุฑูุฉ ูุงุนูุฉ ุนูุฏ hover */
      transition: background 0.3s;
    }

    /* ุชุบููุฑ ุงูุฎูููุฉ ุนูุฏ ุชูุฑูุฑ ุงููุงูุณ */
    nav a:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ุชูุณูู ุญุงููุฉ ุงูููุชุฌุงุช */
    main.container {
      display: grid;

      /* ุดุจูุฉ ูุฑูุฉ ุญุณุจ ุญุฌู ุงูุดุงุดุฉ */
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));

      /* ูุณุงูุงุช ุจูู ุงููุฑูุช */
      gap: 20px;

      /* ูุณุงูุฉ ุฏุงุฎููุฉ */
      padding: 40px;
    }

    /* ุชูุณูู ูุฑุช ุงูููุชุฌ */
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      text-align: center;
      padding: 16px;

      /* ุชุฃุซูุฑุงุช ุญุฑูุฉ */
      transition: transform 0.3s ease, background 0.3s ease;
    }

    .card:hover {
      /* ุนูุฏ ุชูุฑูุฑ ุงููุงูุณ ููู ูุฑุช ุงูููุชุฌ */
      /* ุฑูุน ุงููุฑุช ููุฃุนูู ูุฅุนุทุงุก ุฅุญุณุงุณ ุจุงูุญุฑูุฉ */
      transform: translateY(-5px);

      /* ุฒูุงุฏุฉ ุดูุงููุฉ ุงูุฎูููุฉ ูุฅุจุฑุงุฒ ุงููุฑุช */
      background: rgba(255,255,255,0.2);
    }

    .card img {
      /* ุฌุนู ุงูุตูุฑุฉ ุชุฃุฎุฐ ูุงูู ุนุฑุถ ุงููุฑุช */
      width: 100%;

      /* ุชุฏููุฑ ุญูุงู ุงูุตูุฑุฉ */
      border-radius: 12px;

      /* ูุณุงูุฉ ุฃุณูู ุงูุตูุฑุฉ */
      margin-bottom: 10px;

      /* ุงููุญุงูุธุฉ ุนูู ุฃุจุนุงุฏ ุงูุตูุฑุฉ ุจุฏูู ุชุดููู */
      object-fit: cover;

      /* ุชุญุฏูุฏ ุงุฑุชูุงุน ุซุงุจุช ููุตูุฑุฉ */
      height: 180px;
    }

    .btn {
      /* ููู ุฎูููุฉ ุงูุฒุฑ */
      background: #fff;

      /* ููู ุงููุต ุฏุงุฎู ุงูุฒุฑ */
      color: #4b0082;

      /* ุฅุฒุงูุฉ ุงูุฅุทุงุฑ ุงูุงูุชุฑุงุถู */
      border: none;

      /* ุชุฏููุฑ ุญูุงู ุงูุฒุฑ */
      border-radius: 10px;

      /* ูุณุงูุงุช ุฏุงุฎููุฉ ููุฒุฑ */
      padding: 8px 14px;

      /* ุชุบููุฑ ุดูู ุงููุคุดุฑ ุนูุฏ ุงููุฑูุฑ */
      cursor: pointer;

      /* ุฌุนู ุงูุฎุท ุนุฑูุถ */
      font-weight: bold;

      /* ุญุฑูุฉ ูุงุนูุฉ ููุชุฃุซูุฑุงุช */
      transition: 0.3s;
    }

    .btn:hover {
      /* ุชุบููุฑ ููู ุงูุฎูููุฉ ุนูุฏ ุชูุฑูุฑ ุงููุงูุณ */
      background: #e2d4ff;

      /* ุชูุจูุฑ ุงูุฒุฑ ูููููุง ูุฅุญุณุงุณ ุงูุชูุงุนู */
      transform: scale(1.05);
    }

    footer {
      /* ุชูุณูุท ุงููุต ุฏุงุฎู ุงูููุชุฑ */
      text-align: center;

      /* ูุณุงูุฉ ุฏุงุฎููุฉ */
      padding: 20px;

      /* ููู ูุต ูุงุฏุฆ */
      color: #ccc;

      /* ุฎูููุฉ ุดูุงูุฉ */
      background: rgba(255,255,255,0.08);

      /* ุฎุท ูุงุตู ุฃุนูู ุงูููุชุฑ */
      border-top: 1px solid rgba(255,255,255,0.15);
    }
  </style>
</head>

<body>
  <!-- ุงูููุฏุฑ ุงูุฑุฆูุณู ูููููุน -->
  <header class="container">
    <!-- ุงุณู ุงููุชุฌุฑ ุงููุนุฑูุถ ุฃุนูู ุงูุตูุญุฉ -->
    <h1>Modern MiniStore ๐๏ธ</h1>

    <!-- ูุงุฆูุฉ ุงูุชููู -->
    <nav>
      <!-- ุฑุงุจุท ุตูุญุฉ ุงูููุชุฌุงุช -->
      <a href="index.php">ุงูููุชุฌุงุช</a>

      <!-- ุฑุงุจุท ุตูุญุฉ ุงูุนุฑุจุฉ -->
      <a href="cart.php">ุงูุนุฑุจุฉ</a>

      <!-- ุฑุงุจุท ุตูุญุฉ ุทูุจุงุช ุงููุณุชุฎุฏู -->
      <a href="my_orders.php">ุทูุจุงุชู</a>

      <!-- ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ุฃุฏูู -->
      <?php if (is_admin()): ?>
        <!-- ุฑุงุจุท ููุญุฉ ุชุญูู ุงูุฃุฏูู -->
        <a href="admin_dashboard.php">ููุญุฉ ุงูุชุญูู (ูุณุคูู)</a>

        <!-- ุฑุงุจุท ุนุฑุถ ุฌููุน ุงูุทูุจุงุช -->
        <a href="orders.php">ุงูุทูุจุงุช</a>

        <!-- ุชุณุฌูู ุฎุฑูุฌ ุงูุฃุฏูู -->
        <a href="admin_logout.php">ุฎุฑูุฌ ุงููุณุคูู</a>
      <?php else: ?>
        <!-- ูู ุญุงู ูู ููู ุฃุฏููุ ูุธูุฑ ุฎูุงุฑ ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู -->
        <a href="admin_login.php">ุฏุฎูู ุงููุณุคูู</a>
      <?php endif; ?>

      <!-- ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู -->
      <?php if (is_logged_in()): ?>
        <!-- ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ูุน ุญูุงูุฉ XSS -->
        <span>ูุฑุญุจุงูุ <?= htmlspecialchars($_SESSION['user']['name']) ?></span>

        <!-- ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู -->
        <a href="user_logout.php">ุฎุฑูุฌ</a>
      <?php else: ?>
        <!-- ุฑูุงุจุท ุชุณุฌูู ุงูุฏุฎูู ูุงูุชุณุฌูู -->
        <a href="user_login.php">ุฏุฎูู</a>
        <a href="user_register.php">ุชุณุฌูู</a>
      <?php endif; ?>
    </nav>
  </header>

  <main class="container" id="products-list">
    <!-- ุฑุณุงูุฉ ูุคูุชุฉ ุชุธูุฑ ูููุณุชุฎุฏู -->
    <!-- ูุชู ุนุฑุถูุง ูุจู ุชุญููู ุงูููุชุฌุงุช ูู ุงูุณูุฑูุฑ -->
    <!-- ุชูุชุฏ ุนูู ูุงูู ุนุฑุถ ุงูุดุจูุฉ -->
    <p style="grid-column:1/-1;text-align:center;color:#eee;">
      ุฌุงุฑู ุชุญููู ุงูููุชุฌุงุช...
    </p>
</main>

<!-- ููุชุฑ ุงููููุน -->
<footer>
  <!-- ุญููู ุงููุดุฑ -->
  <p>ยฉ 2025 Modern MiniStore. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
</footer>

<script>
  // ูุชุบูุฑ JavaScript ูุญุฏุฏ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
  // ุงููููุฉ ุชุฃุชู ูู PHP:
  // - true ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู
  // - false ุฅุฐุง ูู ููู ูุณุฌู
  const loggedIn = <?php echo is_logged_in() ? 'true' : 'false'; ?>;

  // ุฏุงูุฉ ุบูุฑ ูุชุฒุงููุฉ ูุชุญููู ุงูููุชุฌุงุช ูู API
  async function loadProducts() {

    // ุฌูุจ ุนูุตุฑ <main> ุงูุฐู ุณูุชู ุนุฑุถ ุงูููุชุฌุงุช ุจุฏุงุฎูู
    const listEl = document.getElementById('products-list');

    try {
      // ุฅุฑุณุงู ุทูุจ HTTP ุฅูู ููู API ุงููุณุคูู ุนู ุงูููุชุฌุงุช
      const res = await fetch('api/products.php');

      // ูู ุญุงู ูุดู ุงูุทูุจ (ูุซู 404 ุฃู 500)
      // ูุชู ุฑูู ุฎุทุฃ ูุฏูููุง
      if (!res.ok) throw new Error('ูุดู ุชุญููู ุงูููุชุฌุงุช');

      // ุชุญููู ุงูุงุณุชุฌุงุจุฉ ูู JSON ุฅูู ูุงุฆู JavaScript
      const products = await res.json();

      // ุฅุฐุง ูู ููู ููุงู ุฃู ููุชุฌุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
      if (!products.length) {
        // ุนุฑุถ ุฑุณุงูุฉ ุชููุฏ ุจุนุฏู ูุฌูุฏ ููุชุฌุงุช
        listEl.innerHTML = `
          <p style="grid-column:1/-1;text-align:center;">
            ๐ซ ูุง ุชูุฌุฏ ููุชุฌุงุช ุญุงููุงู.
          </p>
        `;
        return;
      }

      // ุจูุงุก ูุฑูุช ุงูููุชุฌุงุช ุจุงุณุชุฎุฏุงู map
      // ููู ููุชุฌ ูุชู ุฅูุดุงุก HTML ุฎุงุต ุจู
      listEl.innerHTML = products.map(p => `
        <div class="card">
          <!-- ุตูุฑุฉ ุงูููุชุฌ -->
          <!-- ุฅุฐุง ูู ุชูุฌุฏ ุตูุฑุฉ ูุชู ุงุณุชุฎุฏุงู ุตูุฑุฉ ุงูุชุฑุงุถูุฉ -->
          <img src="${p.image_url || 'assets/no_image.png'}" alt="${p.name}">

          <!-- ุงุณู ุงูููุชุฌ -->
          <h3>${p.name}</h3>

          <!-- ุณุนุฑ ุงูููุชุฌ -->
          <p>USD ${p.price.toFixed(2)}</p>

          <!-- ุงูุชุญูู ูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู -->
          ${loggedIn
            // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
            ? `<a class="btn" href="cart_add.php?id=${p.id}">
                 ุฃุถู ุฅูู ุงูุนุฑุจุฉ ๐
               </a>`
            // ุฅุฐุง ูู ููู ูุณุฌู ุฏุฎูู
            : `<a class="btn" href="user_login.php">
                 ุณุฌูู ุงูุฏุฎูู ููุดุฑุงุก
               </a>`
          }
        </div>
      `).join('');

    } catch (e) {
      // ูู ุญุงู ุญุฏูุซ ุฃู ุฎุทุฃ:
      // - ูุดู ุงูุงุชุตุงู
      // - ูุดููุฉ ูู ุงูุณูุฑูุฑ
      // ูุชู ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑ ูููุณุชุฎุฏู
      listEl.innerHTML = `
        <p style="grid-column:1/-1;text-align:center;">
          โ๏ธ ุชุนุฐุฑ ุชุญููู ุงูููุชุฌุงุช.
        </p>
      `;
    }
  }

  // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุชุญููู ุงูููุชุฌุงุช ููุฑ ุชุญููู ุงูุตูุญุฉ
  loadProducts();
</script>
</body>
</html>

