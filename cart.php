<?php
// ุชุญููู ููู ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ
// ูุญุชูู ุนูู:
// - ุจูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
// - BASE_URL
// - ุงูููุทูุฉ ุงูุฒูููุฉ
require_once __DIR__ . '/config.php';

// ุงูุชุญูู ุฅุฐุง ูู ูุชู ุจุฏุก ุงูุฌูุณุฉ ุจุนุฏ
// ุงูุฌูุณุฉ ุชูุณุชุฎุฏู ูุชุฎุฒูู:
// - ุจูุงูุงุช ุงููุณุชุฎุฏู
// - ุจูุงูุงุช ุงูุนุฑุจุฉ
// - ุญุงูุฉ ุงูุฃุฏูู
if (session_status() === PHP_SESSION_NONE) session_start();

// ุชุญููู ููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
// db.php ูููุฑ ุฏุงูุฉ db() ุงูุชู ุชูุฑุฌุน ูุงุฆู PDO
require_once __DIR__ . '/db.php';

// ุชุญููู ููู ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูุงูุตูุงุญูุงุช
// auth.php ูุญุชูู ุนูู:
// - is_logged_in()
// - is_admin()
require_once __DIR__ . '/auth.php';

// ุฌูุจ ูุญุชูู ุงูุนุฑุจุฉ ูู ุงูุฌูุณุฉ
// ุฅุฐุง ูู ุชูู ุงูุนุฑุจุฉ ููุฌูุฏุฉุ ูุชู ุชุนููููุง ููุตูููุฉ ูุงุฑุบุฉ
$cart = $_SESSION['cart'] ?? [];
?>

<!DOCTYPE html>
<!-- ุตูุญุฉ HTML ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุจุงุชุฌุงู ูู ุงููููู ูููุณุงุฑ -->
<html lang="ar" dir="rtl">
<head>
  <!-- ุชุฑููุฒ UTF-8 ูุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ -->
  <meta charset="UTF-8" />

  <!-- ุฅุนุฏุงุฏุงุช ุงูุงุณุชุฌุงุจุฉ ููุดุงุดุงุช ุงููุฎุชููุฉ -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ุนููุงู ุงูุตูุญุฉ -->
  <title>ุงูุนุฑุจุฉ - Mini Storefront</title>

  <!-- ุฑุจุท ููู CSS -->
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>

<!-- ุงูููุฏุฑ ุงูุฑุฆูุณู -->
<header class="container">
  <!-- ุนููุงู ุงูุตูุญุฉ -->
  <h1>๐งบ ุงูุนุฑุจุฉ</h1>

  <!-- ุดุฑูุท ุงูุชููู -->
  <nav>
    <!-- ุฑุงุจุท ุงูููุชุฌุงุช -->
    <a href="index.php">ุงูููุชุฌุงุช</a>

    <!-- ุฑุงุจุท ุงูุนุฑุจุฉ -->
    <a href="cart.php">ุงูุนุฑุจุฉ</a>

    <!-- ุฑุงุจุท ุทูุจุงุช ุงููุณุชุฎุฏู -->
    <a href="my_orders.php">ุทูุจุงุชู</a>

    <!-- ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ุฃุฏูู -->
    <?php if (is_admin()): ?>
      <!-- ููุญุฉ ุชุญูู ุงูุฃุฏูู -->
      <a href="admin_dashboard.php">ููุญุฉ ุงูุชุญูู (ูุณุคูู)</a>

      <!-- ุตูุญุฉ ุงูุทูุจุงุช -->
      <a href="orders.php">ุงูุทูุจุงุช</a>

      <!-- ุชุณุฌูู ุฎุฑูุฌ ุงูุฃุฏูู -->
      <a href="admin_logout.php">ุฎุฑูุฌ ุงููุณุคูู</a>
    <?php else: ?>
      <!-- ุฅุฐุง ูู ููู ุฃุฏูู -->
      <a href="admin_login.php">ุฏุฎูู ุงููุณุคูู</a>
    <?php endif; ?>

    <!-- ูู ุญุงู ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู -->
    <?php if (is_logged_in()): ?>
      <!-- ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ูุน ุญูุงูุฉ ูู XSS -->
      <span>ูุฑุญุจุงูุ <?php echo htmlspecialchars($_SESSION['user']['name']); ?></span>

      <!-- ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู -->
      <a href="user_logout.php">ุฎุฑูุฌ</a>
    <?php else: ?>
      <!-- ุฑูุงุจุท ุชุณุฌูู ุงูุฏุฎูู ูุงูุชุณุฌูู -->
      <a href="user_login.php">ุฏุฎูู</a>
      <a href="user_register.php">ุชุณุฌูู</a>
    <?php endif; ?>
  </nav>
</header>

<!-- ูุญุชูู ุงูุตูุญุฉ -->
<main class="container">
<?php
// ุงูุชุญูู ุฅุฐุง ูุงูุช ุงูุนุฑุจุฉ ูุงุฑุบุฉ
if (!$cart) {

    // ุนุฑุถ ุฑุณุงูุฉ ูููุณุชุฎุฏู
    echo '<p>ุนุฑุจุชู ูุงุฑุบุฉ.</p>';

} else {

    // ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
    $pdo = db();

    // ุงุณุชุฎุฑุงุฌ IDs ุงูููุชุฌุงุช ูู ุงูุนุฑุจุฉ
    // array_keys ุชูุฑุฌุน ููุงุชูุญ ุงููุตูููุฉ (product_id)
    // intval ูุชุญููููุง ูุฃุฑูุงู ุตุญูุญุฉ
    $ids = array_map('intval', array_keys($cart));

    // ุฅูุดุงุก placeholders ูุนูุงูุงุช ุงูุงุณุชููุงู ูู SQL
    // ูุซุงู: ?, ?, ?
    $in  = implode(',', array_fill(0, count($ids), '?'));

    // ุชุญุถูุฑ ุงูุงุณุชุนูุงู ูุฌูุจ ุจูุงูุงุช ุงูููุชุฌุงุช
    $stmt = $pdo->prepare(
        "SELECT id, name, price FROM products WHERE id IN ($in)"
    );

    // ุชูููุฐ ุงูุงุณุชุนูุงู ูุน ุชูุฑูุฑ IDs
    $stmt->execute($ids);

    // ุฌูุจ ุงููุชุงุฆุฌ ููุตูููุฉ
    $items = $stmt->fetchAll();

    // ูุชุบูุฑ ูุชุฌููุน ุงูุณุนุฑ ุงูููู
    $total = 0;

    // ุจุฏุงูุฉ ุฌุฏูู ุนุฑุถ ุงูุนุฑุจุฉ
    echo '
      <table class="table">
        <thead>
          <tr>
            <th>ุงูููุชุฌ</th>
            <th>ุงููููุฉ</th>
            <th>ุงูุณุนุฑ</th>
            <th>ุงูุฅุฌูุงูู</th>
          </tr>
        </thead>
        <tbody>
    ';

    // ุงููุฑูุฑ ุนูู ูู ููุชุฌ
    foreach ($items as $it) {

        // ุฌูุจ ูููุฉ ุงูููุชุฌ ูู ุงูุนุฑุจุฉ
        $qty = $cart[$it['id']] ?? 0;

        // ุญุณุงุจ ุฅุฌูุงูู ุงูุณุนุฑ ููุฐุง ุงูููุชุฌ
        $line = $qty * (float)$it['price'];

        // ุฅุถุงูุฉ ุงูุณุนุฑ ููุฅุฌูุงูู ุงูููู
        $total += $line;

        // ุทุจุงุนุฉ ุตู ุงูููุชุฌ ุฏุงุฎู ุงูุฌุฏูู
        echo '
          <tr>
            <td>'.h($it['name']).'</td>
            <td>'.$qty.'</td>
            <td>'.number_format($it['price'],2).'</td>
            <td>'.number_format($line,2).'</td>
          </tr>
        ';
    }

    // ุฅุบูุงู ุงูุฌุฏูู
    echo '</tbody></table>';

    // ุฒุฑ ุชุฃููุฏ ุงูุทูุจ
    echo '
      <p>
        <a class="btn primary" href="checkout.php">
          ุชุฃููุฏ ุงูุทูุจ (ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู)
        </a>
      </p>
    ';

    // ุนุฑุถ ุงูุฅุฌูุงูู ุงูููู
    echo '
      <p class="total">
        ุงูุฅุฌูุงูู: <strong>'.number_format($total,2).'</strong>
      </p>
    ';

    // ููุงุญุธุฉ ุงูุฏูุน
    echo '
      <p class="muted">
        <em>ุณูุชู ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู ุฃู ุนูุฏ ุงูุงุณุชูุงู ูู ููุทุฉ ุงูุงุณุชูุงู.</em>
      </p>
    ';
}
?>
</main>
</body>
</html>
